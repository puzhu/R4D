---
title: "Travel delayed is travel denied: An empirical study of flight delays and models that seek to predict their occurrence"
author: "Mario"
date: 'Date created: `r Sys.Date()`'
output:
  html_notebook:
    code_folding: hide
    df_print: paged
    highlight: kate
    smart: no
    theme: paper
  html_document:
    toc: no
---

# {.tabset .tabset-fade .tabset-pills}

## Comments

Excellent work in general. This is above an beyond anything I have seen on this. So A ++ to you.

1. What's `page.print = F` doing?
2. You can add r commands in line with markdown content like this (see rmd) `r sum(1:100)`
3. What's stuff like this `color = 'delay | dep time'` within your `aes()` call doing? See below
```{r}
library(gapminder)
gapminder %>% group_by(year) %>% summarise(pop = sum(pop, na.rm = T)) %>% 
ggplot(., aes(x = year, y = pop, color = "black")) + ## the color should be set outside the aes call otherwise it is mapped as a data
  geom_line()
```

## Abstract 

Unpredictable flight delays are a costly problem, forcing travelers to choose between spending unproductive time at the airport and missing a flight. In 2013, flights from the three New York area airports alone saw aggregate delays of half a million minutes.[^1] I explore the predictive capacity with respect to the probability of departure delay of five independent variables -- **scheduled departure time**, **atmomspheric pressure**, **visibility**, **the probability associated with each air carrier**, and **the probability associated with each origin airport**. Notably all five of these variables are forecasted ahead of time and made publicly available.

I then use a logistic regression model, and find that all five independent variables display a correlative relationship with departure delay at a 0.1 percent significance level. The data also suggest that scheduled departure time may be used to estimate the probability of departure delay as follows:^2^

> Probability of departure delay = 1 / (1 + e^-(0.28 - 0.002 * difference between 7:35 pm and scheduled departure time in minutes))

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
## Load needed packages
library(tidyverse); library(nycflights13); library(stringr); library(lubridate); library(ggthemes); library(moments)
```


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
## Filter out entries where departure delay is NULL
## Because observed probability will be used as a benchmark to test the model, remove departure times with limited observations
test_a <- flights %>% 
  filter(!is.na(dep_delay) == T) %>% 
  group_by(sched_dep_time) %>%
  filter(n() >= 100) %>% 
  ungroup()

# test_a
```


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
## Next, mutate scheduled departure time from integer to time object to do time operations on it
test_b <- test_a %>%
  mutate(dep_time_object = hm(paste
                              (trunc(sched_dep_time/100) ## This line provides the hour
                                ,str_sub(sched_dep_time,-2,-1))) ## This line provides the minute
         ,sched_dep_time_metric = 100 * (trunc(sched_dep_time/100)) + as.numeric(str_sub(as.character(sched_dep_time), -2, -1)) / 3 * 5)

# test_b
```


```{r}
sample_n(flights %>% select(sched_dep_time), size = 20) %>% 
  mutate(sched_dep_time_hm =  str_pad(as.character(sched_dep_time), width = 4, side = "left", pad = "0"), 
        diff_20 = paste(str_sub(sched_dep_time_hm, start = 1, end = 2), str_sub(sched_dep_time_hm, start = 3, end = 4), sep = ":") %>% 
          hm(.) - hm("20:00")) %>% 
  mutate(dep_time_object = hm(paste(trunc(sched_dep_time/100) ## This line provides the hour
                                ,str_sub(sched_dep_time,-2,-1))) ## This line provides the minute
         ,sched_dep_time_metric = 100 * (trunc(sched_dep_time/100)) + as.numeric(str_sub(as.character(sched_dep_time), -2, -1)) / 3 * 5,
        diff_1935h = abs(as.numeric(dep_time_object - hm('19:35')) / 60))
```



```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
## Next, mutate delay time to a binary i.e. Is it delayed (YN)
## Find time difference between scheduled departure time and 8 pm
## Find the observed probability by time i.e. delayed flights / all flights

test_c <- test_b %>%
  mutate(is_delay = if_else(dep_delay > 0, 1, 0)
         ,diff_1935h = abs(as.numeric(dep_time_object - hm('19:35')) / 60)) %>%
  group_by(diff_1935h) %>%
  mutate(op_diff1935 = mean(is_delay, na.rm = T)) %>%
  ungroup()

# test_c
```


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
## Use the bivariate model created later to predict probability for each scheduled departure time
test_d <- test_c %>%
  mutate(pred_bivar = 1/(1+exp(-(0.279603750 - 0.001999519 * diff_1935h))))
```





```{r echo=FALSE, message=FALSE, warning=F, paged.print=FALSE, cache=TRUE}

ggplot(data = test_d, mapping = aes(x = sched_dep_time_metric, y = op_diff1935, color = 'observed probability')) +
  geom_point(size = 1) +
  geom_line(data = test_d, mapping = aes(x = sched_dep_time_metric, y = pred_bivar, color = 'predicted probability'), size = 1.5) +
  geom_line(size = 1, aes(x = sched_dep_time_metric, y = 0.39094, color = 'gray')) +
  ggtitle('Fly in the morning to lower your chance for delay') +
  scale_color_fivethirtyeight(labels = c('baseline p', 'observed p', 'pred. p')
                              ,name = 'Prob. of delay given sched. dep. time') +
  theme_fivethirtyeight()
  

```


---  

*^1^ Bureau of Transportation Statistics, "Reporting Carrier On-Time Performance", via Rstudio*  
*^2^ e refers to Euler's number, a mathematical constant roughly equal to 2.72*





## Background

### PROBLEM:
Flight delays are unpredictable. Mis-timing your ride to the airport could be costly; Arrive late and you may miss your flight altogether, but arrive early and you'll spend even more uncomfortable, unproductive time at the gate. In an ideal world, all flights would simply leave on time. In a second-best world, each airline would contact travelers directly with flight delay information that was accurate and timely enough to be actionable. Alas, neither of those are the case.

### GOAL:
My ultimate goal is to be able to best predict whether a flight will be delayed using weather, plane, and flight data.

### HYPOTHESIS:
My null hypothesis is that *no* available weather, plane, or flight data shares a relationship with flight delay. I'll seek to disprove this.

## Setting up

To set up, I'll do the following:

1. Set a baseline probability
2. Link flight data with data to the planes flown and the weather contemporaneous to each flight
3. Find a baseline probability for departure delay
4. Clean and adapt the data both so that it makes sense logically and is testable; This will include:
    a. Setting negative departure delay values equal to zero^3^
    b. Replacing categorical data -- such as the name of an airline -- with an "object effect" that estimates the added chance for delay associated with any object
5. Start an appendix of metadata, including:
    a. A data dictionary
    b. A data lineage diagram


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
### On the code side, I'll do the following:

# 1. Install and enable R packages to explore, manipulate, and analyze the data
# 2. Finding a baseline for departure delay by counting delayed and on-time flights 
# 3. Use common fields to join flight table w/weather and plane tables
# 4. Select columns to be removed
# 5. Mutate some columns so they're more useful. Specifically, I group categorical variables and estimate a conditional probability using observed delay data

### 1. Install packages, as needed 
# install.packages('tidyverse'); install.packages('skimr'); install.package('lubridate');
# install.packages('ggthemes'); install.packages('DiagrammeR')

# This line enable packages
library(tidyverse); library(nycflights13); library(lubridate); library(ggthemes); library(reshape2); library(DiagrammeR); library(skimr)
```


### BASELINE

I'll set a baseline probability by finding how many flights were delayed in 2013 and dividing by the total number of flights, while accounting for flights that didn't have delay information available.
```{r echo=FALSE, include=FALSE, warning=FALSE}

op_base <- sum(flights$dep_delay > 0, na.rm = T) / sum(!is.na(flights$dep_delay))
## op_base = 0.39094
```


The baseline probability of delay is 39.094 percent


### JOIN DATA TABLES

Link tables of flight, plane, and weather data together to create a thick data set
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
### 3. Join flight, plane, and weather data into a single data frame of raw data to work with

flt_raw <- flights %>%
  left_join(rename(planes,'manuf_year' = year), by = 'tailnum') %>% ## Rename plane manufacture year from 'year' to 'manuf_year' to not confuse it with flight year
  left_join(weather, by = c('time_hour', 'origin'))
```


### REMOVE IRRELEVANT COLUMNS

Some flight, plane, and weather data are irrelevant or redundant and may be removed
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
### Remove irrelevant columns

flt_test_00 <- flt_raw %>%
  filter(!is.na(dep_delay) == T) %>%
  select(-year.x, -month.x, -day.x, -hour.x ## Ex ante flight info 1
         ,-minute, -sched_arr_time, -flight ## Ex ante flight info 2
         ,-tailnum, -dest, -time_hour ## Ex ante flight info 3
         ,-dep_time, -arr_time ## Post hoc flight info 1
         ,-arr_delay ,-air_time ## Post hoc flight info 2
         ,-year.y, month.y, -day.y, -hour.y) ## Weather reading time

## Here's what's kept:
##(dep_delay, sched_dep_time, distance, manuf_year, engines ## 1-5
##         ,seats, temp, dewp, humid, wind_speed,wind_gust, precip ## 6-12
  ##       ,pressure, visib, distance ## 13-15
    ##     ,carrier, origin, type, manufacturer ## cat cols 16-19
      ##   ,model, speed ,engine) %>% ## cat cols 20-22
  
```


### MUTATE SOME COLUMNS

First, convert scheduled departure time to a time object
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
flt_test_01 <- flt_test_00 %>%
  mutate(sched_dep_time_object = hm(paste
     (trunc(sched_dep_time/100) ## This line provides the hour
         ,str_sub(sched_dep_time,-2,-1)))) ## This line provides the minute
```


Now to look at the delay data based on scheduled departure time
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
flt_test_01 %>%
  group_by(as.numeric(sched_dep_time_object)) %>%
  filter(n() > 100) %>% ## Limit to sched dep times with over 100 instances
  mutate(is_delay = if_else(dep_delay > 0, 1, 0), ## Turning delay from minutes delayed into a binary
         op_sched_dep = mean(is_delay, na.rm = T), ## I find an observed probability for delay by grouping all flights of a given sched_dep_time together and counting delay
         sched_dep_time_metric = round((sched_dep_time / 100 - trunc(sched_dep_time / 100)) * 500/3 + 100 * (trunc(sched_dep_time / 100)))) %>% ## I convert sched dep time to metric because it looks better graphed
  ungroup() %>%
  select(sched_dep_time_metric, op_sched_dep) %>%
  unique() %>%
  ggplot(mapping = aes(x = sched_dep_time_metric, y = op_sched_dep, color = 'delay | dep time')) +
     geom_point() +
  geom_smooth(method = 'loess', mapping = aes(color = 'smoothed delay | dep time')) +
  ggtitle('Likelihood of departure delay peaks around 7:35 p.m.') +
  scale_color_fivethirtyeight(labels = c('observed p', 'smoothed observed p')
                              ,name = 'Prob. of delay given sched. dep. time') +
    theme_fivethirtyeight()
```


This graph appears to show that the probability of departure delay increases as the day moves along, peaks around 7:35 p.m., then drops again until midnight.

To verify the time numerically, find the correlation with observed probability for each time, then find the max among the outputs.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}

temp_df <- flights %>%
  filter(!is.na(dep_delay)) %>% ## Removing na values of departure delay
  mutate(is_delay = if_else(dep_delay > 0, 1, 0)
         ,sched_dep_time_metric = round((sched_dep_time / 100 - trunc(sched_dep_time / 100)) * 500/3 + 
                                         100 * (trunc(sched_dep_time / 100))))

results_df <- tibble(i= 1L, cor_i = 0.1234)

for(i in 1:2399){ ## It's a for loop for every metric time to diff from
  results_df[i, 1] <- paste(trunc(i / 100), trunc((i %% 100) * 3 / 5), sep = ':') ## This puts the clock time we're diffing from in each row
  results_df[i, 2] <- cor(abs(i - temp_df$sched_dep_time_metric), temp_df$is_delay)} ## This puts the time-diff's correlation with is_delay

filter(results_df, abs(cor_i) == max(abs(cor_i))) ## This gives us the max value
```


The max correlation is at 7:35 p.m.

The numbers confirm what the graph suggests. Based on the assumption that the delays are approximately symmetric about 7:35 p.m., mutate scheduled departure time by finding the time difference between each scheduled flight time and 7:35 p.m.
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

flt_test_02 <- flt_test_01 %>%
  mutate(is_delay = if_else(dep_delay > 0, 1, 0)
         ,diff_1935h = abs(as.numeric(sched_dep_time_object - hm('19:35')) / 60)) %>%
  group_by(diff_1935h) %>%
  mutate(op_diff1935 = mean(is_delay, na.rm = T)) %>%
  ungroup()
```


Mutate the other categorical variables. Categorical variables may be used as inputs in a logistic regression. However, I'll mutate them here into an effect that reflects the difference associated with any given carrier, origin airport, and so forth:
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

flt_test_03 <- flt_test_02 %>%
  group_by(carrier) %>%
     mutate(op_carr = sum(is_delay>0) / length(is_delay) - op_base) %>%
     ungroup() %>%
  group_by(origin) %>%
     mutate(op_ogn = sum(is_delay>0) / length(is_delay) - op_base) %>%
     ungroup() %>%
  group_by(type) %>%
     mutate(op_type = sum(is_delay>0) / length(is_delay) - op_base) %>%
     ungroup() %>%
  group_by(manufacturer) %>%
     mutate(op_mnf = sum(is_delay>0) / length(is_delay) - op_base) %>%
     ungroup() %>%
  group_by(model) %>%
     mutate(op_mdl = sum(is_delay>0) / length(is_delay) - op_base) %>%
     ungroup() %>%
  group_by(speed) %>%
     mutate(op_spd = sum(is_delay>0) / length(is_delay) - op_base) %>%
     ungroup() %>%
  group_by(engine) %>%
     mutate(op_eng = sum(is_delay>0) / length(is_delay) - op_base) %>%
     ungroup()
```


Because travelers may want to refer to delays associated with members of each category, the observed probabilities will be listed in the Appendix alongside their names in a table of Category Factors, or cat_facts.
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
### This code creates a separate data frame which links categorical variables to their relative probabilities
cat_facts <- flt_test_03 %>%
  select(3:4, 7:9, 12:13, 28:34) %>% ## These are each category plus their associated factors
  unique() %>%
  gather(key = 'cat', value = 'obj', carrier, origin, type, manufacturer, model, speed, engine) %>% ## To make it more readable, this puts all facts into just two columns
  rename(carrier = op_carr
         ,origin = op_ogn
           ,type = op_type
   ,manufacturer = op_mnf
          ,model = op_mdl
          ,speed = op_spd
         ,engine = op_eng) %>%
  gather(key = 'trans', value = 'facts', 1:7) %>%
  filter(cat == trans) %>%
  select(-trans) %>%
  unique() %>%
  filter(!is.na(obj) == T) %>%
  arrange(cat,desc(facts))

# cat_facts
```  


---  

^3^ A negative departure delay value would decrease a category mean as though it is "more on time". To better intuit this, suppose an airline has one flight that leaves 30 minutes early and another that leaves 30 minutes late every day. On paper, the mean of 0 minutes delayed would appear as though a traveler need not worry about delays when flying on this airline, but this is not the case; Rather, there's a 50 percent chance they'll depart late. Because of that, I chose to zero out negative departure delay values.

## Univariate analysis

Here are the steps for this

1. Explore metadata to ensure understanding of what each variable represents
2. Descriptive statics of the dependent variable, departure delay, including number of observations, mean, standard deviation, median, min, max, and interquartile measures
3. A histogram will offer a visual representation

Doing this will expose:

* Fields that would be unlikely related to departure delay,
* Fields that will require transformation, and
* Fields with too few observations or with too many missing observations to be representative


### ADDITIONAL METADATA

The package's documentation offers extensive metadata information.^4^

See appendix for data dictionary and data lineage


### DESCRIPTIVE STATS OF THE DEPENDENT VARIABLE:

First, I'll prepare a histogram of departure delay. As you'll see, the data is very concentrated near zero and heavily skewed to the right. That is, most flights were on time or nearly so, but occasionally, flights had very long delays.  I'll cut off at the 97.5th percentile so it's easier to see
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}

flights %>% ##
  select(dep_delay) %>%
  filter(!is.na(dep_delay) == T
           & dep_delay < as.numeric(quantile(flights %>% ## This filter finds the departure delay value associated with the 97.5th percentile
           filter(!is.na(dep_delay) ==T) %>%
           select(dep_delay) %>%
           as_vector(), probs = .975))) %>%
  mutate(dep_delay = (dep_delay + abs(dep_delay)) / 2  ## This line turns negative dep_delay into 0
         ,dep_delay_skew = skewness(flights$dep_delay, na.rm = T)) %>% ## Takes skew
  as_tibble() %>%
  ggplot(data = ., mapping = aes(x = dep_delay, fill = 'dep delay (min)')) +
  geom_histogram(binwidth = 5, na.rm = T) +
  theme_fivethirtyeight() +
  ggtitle('Dep delay is concentrated near 0 and skewed right') +
  scale_color_fivethirtyeight(name = 'Scheduled departure time and chance of delay') +
  guides(fill = guide_legend(title = NULL)) +
    theme_fivethirtyeight()

```


Let's look at 6 percentiles to verify that this is not normal by checking the probabilities associated with one-tailed z-scores of 0.5 to 3.0, by 0.5. If this were a normal distribution, the difference between the delay values associated with these z-scores would be approximtely equal.
```{r echo=FALSE, message=FALSE, warning=FALSE}

quantile(flights %>%
           filter(!is.na(dep_delay) ==T) %>%
           select(dep_delay) %>%
           mutate(dep_delay = (dep_delay + abs(dep_delay))/2) %>%
           as_vector(), probs = c(0.6915, 0.8413,0.9332 ## p(z < 0.5, 1.0, 1.5)
                                  ,0.9772, 0.9938, 0.9987)) ## p(z < 2.0, 2.5, 3.0)
```


In a normal distribution, the distance between each of these would be equal. **It would make more sense to predict the probability of any delay given other factors rather than trying to predict the length of a delay**

Given this decision, the previous histogram doesn't make much sense.

To start on building a logistic regression, find a baseline value for the probability that a flight will be delayed, using only the dep_delay column and produce a fairly boring graph
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

op_base <- (flights %>% filter(dep_delay > 0) %>% nrow()) / (flights %>% filter(!is.na(dep_delay) == T) %>% nrow())
```


That baseline is 39 percent. This needs to be graphed
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}

as_tibble(op_base) %>%
  ggplot(mapping = aes(x=0, y=0.39094)) +
  geom_point(size = 0) +
  geom_abline(intercept = 0.39094, slope = 0, color = 'blue', size = 1) +
  scale_color_fivethirtyeight() +
  theme_fivethirtyeight() +
  ggtitle('Assume a 39 percent chance of delay if no data') +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```


*^4^ See [nycflights documentation](https://cran.r-project.org/web/packages/nycflights13/nycflights13.pdf "nycflights docs")*

## Multivariate analysis

There are steps here too

1. Descriptive statistics for the independent variables
2. Explore relationships between variables
3. Find correlation with our dependent variable
4. Model the best relationships


### Descriptive statistics for the independent variables

Based on the data dictionary, the following fields are either unlikely to be related to departure delay or duplicative of another, superior field in the data set

* Destination
* Tail number
* Arrival time
* Day of the month
* Flight number
* Scheduled arrival time
* Year
* Air time
* Arrival delay
* Departure time
* Distance

Only one field among those remaining, **wind gust**, is concerning due to the number of n/a entries -- 256,391 of 336,776 total. My fear is that these incomplete entries are biased -- that is, we may be telling a story that is based on a sample of the data that does not represent the poopulation.

To test, I'll produce summary statistics for wind gusts that are present and missing:
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
### Here, I split up all entries based on whether or not wind_gust is NULL
### Then, look at descriptive statistics of delay by those groups

flt_test_03 %>%
  select(wind_gust, is_delay) %>%
  filter(!is.na(is_delay)) %>%
  mutate(na_gust = if_else(is.na(wind_gust), 0, 1)) %>% 
  group_by(na_gust) %>% 
  summarise(p_del = mean(is_delay)
     ,n_del     = length(is_delay)) %>%
  round(2)
```


The data looks similar enough. Now to see if the graphs look similar
```{r echo=FALSE, message=FALSE, warning=FALSE}
flt_test_03 %>%
  select(wind_gust,is_delay) %>%
  filter(is.na(is_delay) == F) %>%
  mutate(na_gust = factor(if_else(is.na(wind_gust), 0, 1)
                             ,levels = c(0,1)
                             ,labels = c('null', 'not null') )) %>%
  ggplot(aes(is_delay, fill = 'density whether wind gust is NA')) +
  geom_density() +
  ggtitle(label = 'Delay chance differs when wind gust is na but thats OK') +
  theme_fivethirtyeight() +
  facet_wrap(~na_gust, nrow = 2, ncol = 1)
```


These look similar enough to work with. To further verify with numbers, I would do a z-test to see if I'm able to disprove that the means are unequal and an f-test to do the same with the standard deviations. But not today. Today, I will do neither.


### Explore relationships

In testing departure delay and our other variables, I'll be looking for relationships that show a strong, correlative relationship. 

To do this, I'll use R's general linear model (glm) tool. This will expose the strength of each relationship by providing a p-value, which estimates the probability that we'd get at least as extreme a result if NYC flights 2013 were repeated forever. Because we want there to be *little* chance that sampling the actual population gives us results that are extreme relative to our model, we want p-values that are as low as possible.


**I will test the dataset I've created with a significance level of 0.1 percent.**
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
glm_test <- glm(data = flt_test_03, is_delay ~ distance + manuf_year + engines + seats + speed + month.y + temp + dewp + humid + wind_dir + wind_speed + wind_gust + precip + pressure + visib + diff_1935h + op_carr + op_ogn + op_type + op_mnf + op_mdl + op_spd + op_eng, family = binomial)

summary(glm_test)
```


Iterate through the GLM test, limiting to fewer variables
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

glm_test <- glm(data = flt_test_03, is_delay ~ diff_1935h + humid + pressure + visib + op_carr + op_ogn + op_mnf + op_mdl + op_eng, family = binomial)

summary(glm_test)


```


The variables that appear to have significant relationships with dep_delay are: diff_1935h, humidity, pressure, visibility, op_carr, op_ogn, op_mnf, op_mdl, op_eng

### Find correlation with our dependent variable

The analysis could stop with nine variables. However, we should all be concerned with comingled variables. If, for example, we had found instead that both the length of an airplane and the weight of an airplane were associated with departure delays, we might inadvertantly telling the same story twice. That is, because length and weight are, presumably, associated with each other, including the second variable provides no additional information and may instead be crowding out another useful variable.
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
flt_test_03 %>%
  select(diff_1935h, humid, pressure, visib, op_carr, op_ogn, op_mnf, op_mdl, op_eng) %>%
  cor(use = 'pairwise.complete.obs') %>%
  round(2) %>%
  as_tibble() %>%
  mutate(field = c('diff_1935h', 'humid', 'pressure', 'visib', 'op_carr', 'op_ogn', 'op_mnf', 'op_mdl', 'op_eng'))
```


In seeing this correlation table, it's clear that some of our predictor variables may be comingling with each other. Get rid of variables in the relationships with the highest absolute values. Also, those relationships should make logical sense.

Humidity is highly correlated with visibility. This makes sense since more water vapor in the air could make it more difficult to see.
   -humid

Carrier is highly correlated with four variables which are also correlated with each other -- airport of origin, manufacturer, model, and engine. This makes sense because having more of its planes concentrated at one airport provides economies of scale and manufacturers -- who sell plane models with engines in them -- are likely to cut a deal with those who buy in bulk.
   -op_mnf, -op_mdl, -op_eng
   
This brings us to our final five variables: diff_1935h, pressure, visib, op_carr, and op_ogn

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
flt_final <- flt_test_03 %>%
  select(is_delay, diff_1935h, pressure, visib, op_carr, op_ogn)
```


### Model the best relationships

To figure out which single variable is most closely associated with probability of flight delay, I'll build another logistic regression model
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
glm_test <- glm(data = flt_final, is_delay ~ diff_1935h + pressure + visib + op_carr + op_ogn, family = binomial)

summary(glm_test)

coefficients(glm_test)
```


Herethe equation that estimates the probability of a flight being delayed using these five inputs:

1/(1+e^-(
24.377394643 
- 0.001998325 x diff_1935h 
- 0.023033774 x pressure 
- 0.077389351 x visib 
+ 4.185103561 x op_carr 
+ 4.185103561 x op_ogn
))

Among these, diff_1935h appears to be the best. To get a result with only one input, I repeat the same:

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
glm_test <- glm(data = flt_final, is_delay ~ diff_1935h, family = binomial)

summary(glm_test)

coefficients(glm_test)
```


Here is the equation that estimates the probability of a flight being delayed using one input:

1/(1+e^-(0.279603750 - 0.001999519 x diff_1935h))

Now that I've got this equation, I'll plot the observed probability for each group of scheduled departure times on the same graph as my predicted probability. First, I'll find and plot the actual probabilities from 2013.
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
### Finding observed probabilities by scheduled departure time

test_00 <- flights %>%
  left_join(weather, by = c('time_hour', 'origin')) %>%
  left_join(planes, by = 'tailnum') %>%
  filter(!is.na(dep_delay) == T) %>% ## First, filter out flights with missing departure delay values
  group_by(sched_dep_time) %>% 
  filter(n() >= 100) %>% ## Next, filter out schedule departure times with fewer than 100 flights
  ungroup() %>%
  mutate(dep_time_object = hm(paste ## Next, convert departure time to a time object
                              (trunc(sched_dep_time/100) ## This line provides the hour
                                ,str_sub(sched_dep_time,-2,-1))) ## This line provides the minute
         ,sched_dep_time_metric = 100 * (trunc(sched_dep_time/100)) + 5/3 * as.numeric(str_sub(sched_dep_time, -2, -1)) ## Next, convert scheduled departure time to metric time, which is something I made up to make the graph look better
         + as.numeric(str_sub(as.character(sched_dep_time), -2, -1)) / 3 * 5
         ,is_delay = if_else(dep_delay > 0, 1, 0) ## Next, convert minutes delayed to a binary of is delayed
         ,diff_1935h = abs(as.numeric(dep_time_object - hm('19:35')) / 60)) %>% ## Convert scheduled departue time to a number of minutes to or from 7:35 p.m.
  group_by(diff_1935h) %>%
  mutate(op_diff1935 = mean(is_delay, na.rm = T)) %>% ## Find the observed probability grouped by the number of minutes from 7:35 p.m.
  ungroup()
```


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
### Now plot

ggplot() +
  geom_point(data = test_00, mapping = aes(x = sched_dep_time_metric, y = op_diff1935, color = 'Obs. prob. 2013'), size = 1) +
  ggtitle('Delays became more likely until 7:35 then less likely') +
  scale_color_fivethirtyeight(labels = ''
                              ,name = 'Prob. of delay given sched. dep. time') +
  theme_fivethirtyeight()
```


First, add baseline probability
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

if('op_base' %in% colnames(test_00)) {print('already done')} else {
  test_00 <- test_00 %>%
    mutate(op_base = 0.39094)
  }
```


Next, add prediction using bivariate model
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

if('pred_bivar' %in% colnames(test_00)) {print('already done')} else {
  test_00 <- test_00 %>%
    mutate(pred_bivar = 1/(1+exp(-(0.279603750 - 0.001999519 * diff_1935h))))
  }

```


I can also add a prediction using the multivariate model, but will not be able to graph it (in fewer than six dimensions)
```{r message=FALSE, warning=FALSE, include=FALSE}

test_01 <- test_00 %>%
  group_by(carrier) %>%
  mutate(op_carr = sum(is_delay>0) / length(is_delay) - op_base) %>%
  ungroup() %>%
  group_by(origin) %>%
  mutate(op_ogn = sum(is_delay>0) / length(is_delay) - op_base) %>%
  ungroup() %>%
  filter(!is.na(diff_1935h) & !is.na(pressure) & !is.na(visib) & !is.na(op_carr) & !is.na(op_ogn)) %>%
  mutate(pred_multivar = 1/(1+exp(-(24.377394643
                                    - 0.001998325 * diff_1935h
                                    - 0.023033774 * pressure
                                    - 0.077389351 * visib
                                    + 4.185103561 * op_carr
                                    + 4.185103561 * op_ogn))))




```


Before plotting the predicted values, I'll create a function that returns mean squared error and use it on the three prediction models
```{r, echo=FALSE, message=FALSE, warning=FALSE}

resi_err <- function(pred_col = 1) {
  if(is.numeric(pred_col) == T) {
    sse <- sum(na.rm = T, (test_01$op_diff1935 - test_01[pred_col])^2)
    mse <- sse / (nrow(filter(test_01, !is.na(is_delay), !is.na(test_01[pred_col]))) - 2)
    print(colnames(test_01[pred_col]))
    print(paste('sse ', signif(sse, 4), ' mse ', signif(mse, 4)))
    return(mse)
  }
  else {
    print(paste('pred_col must be numeric'))
    stop()
    }
}

op_base_mse <- resi_err(46); pred_bivar_mse <- resi_err(47); pred_multivar_mse <- resi_err(50)
```


Looks like the bivariate model is the best. But let's plot all 3
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot() +
  geom_point(data = test_01, mapping = aes(x = sched_dep_time_metric, y = op_diff1935, color = 'observed probability'), size = 1) +
  geom_line(test_01, mapping = aes(sched_dep_time_metric, pred_bivar, color = 'bivariate prediction'), size = 1.5) +
  geom_line(data = test_01, mapping = aes(x = sched_dep_time_metric, y = op_base, color = 'base prediction'), size = 1.5) +
  ggtitle('Fly in the morning to lower your chance for delay') +
  scale_color_fivethirtyeight(labels = c('baseline p', 'pred p_bivar', 'observed p')
                     ,name = 'Prob. of delay given sched. dep. time') +
  theme_fivethirtyeight()

```


## Test formula using a succeeding year's data

There are updates to the flight data for as recently as 2017 at this Github repository: https://github.com/jayleetx/nycflights .

Let's see how the formula did at predicting. You may want to download this file and store it in the directory you have this notebook in: http://mariobonifacio.github.io/flights_17.csv

```{r echo=FALSE, message=FALSE, warning=FALSE}
### You will need to download this file: http://mariobonifacio.github.io/flights_17.csv

flights_17 <- read_csv2(trim_ws = T, na = 'NULL', file = 'flights_17.csv', col_names = T)

test_17 <- flights_17 %>%
  filter(!is.na(dep_delay) == T) %>%
  mutate(diff_20h = if_else(sched_dep_time < 2000
                                ,1960 - sched_dep_time
                                ,sched_dep_time - 2000)
         ,sched_dep_time_metric = 100 * (trunc(sched_dep_time/100)) 
         + 5/3 * as.numeric(str_sub(sched_dep_time, -2, -1))
         ,pred_prob = 1/(1+exp(-(0.279603750 - 0.001999519 * diff_20h)))) %>%
  group_by(diff_20h) %>%
  filter(n() > 100) %>%
  mutate(is_delay = if_else(dep_delay > 0, 1, 0)
         ,op_delay = mean(is_delay)) %>%
  ungroup()

sse <- sum(na.rm = T, (test_17$op_delay - test_17$pred_prob)^2)
mse <- sse / (nrow(filter(test_17, !is.na(is_delay), !is.na(pred_prob))) - 2)

paste('sse ', sse, 'mse ', mse)
  
test_17 %>%  
  ggplot() +
  geom_point(mapping = aes(x = sched_dep_time_metric, y = op_delay, color = 'Observed p'), size = 1) +
  geom_line(mapping = aes(x = sched_dep_time_metric, y = pred_prob, color = 'Predicted p'), size = 1.5) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight(labels = c('baseline p', 'pred p_bivar')
                     ,name = 'Prob. of delay given sched. dep. time in 2017') +
  ggtitle('The bivariate model works well on 2017 data')


```


Yes, I'm satisfied with this. Alternately I could update the model by replacing the 2013 data with 2017 data or combining them.


## Ax.1 Metadata

**DATA LINEAGE**

The following may serve as a data lineage diagram

Original_source|nycflights13|raw_data_joined|adapted_data
---------------|------------|---------------|------------
transtats.bts.gov/ DL_SelectFields.asp? Table_ID=236|airlines|n/a|n/a
RITA, Bureau of transportation statistics,transtats.bts.gov/ DL_SelectFields.asp? Table_ID=236|flights|flt_raw|flt_test
FAA Aircraft registry,faa.gov/ licenses_certificates/ aircraft_certification/ aircraft_registry/ releasable_aircraft_download/|planes|flt_raw|flt_test
ASOS download from Iowa Environmental Mesonet, mesonet.agron.iastate.edu/ request/ download.phtml|weather|flt_raw|flt_test

**DATA DICTIONARY**

The following table links assets as saved in nycflights13 with associated terms and definitions.

|table|field|term|definition|
|---|---|---|---|
|flights|year|year,month,day|Date of departure or date of weather recording|
|flights|month|year,month,day|Date of departure or date of weather recording|
|flights|day|year,month,day|Date of departure or date of weather recording|
|flights|dep_time|dep_time,arr_time|Actual departure and arrival times (format HHMM or HMM), local tz.|
|flights|sched_dep_time|sched_dep_time,sched_arr_time|Scheduled departure and arrival times (format HHMM or HMM), local tz.|
|flights|dep_delay|dep_delay,arr_delay|Departure and arrival delays, in minutes. Negative times represent early departures/arrivals.|
|flights|arr_time|dep_time,arr_time|Actual departure and arrival times (format HHMM or HMM), local tz.|
|flights|sched_arr_time|sched_dep_time,sched_arr_time|Scheduled departure and arrival times (format HHMM or HMM), local tz.|
|flights|arr_delay|dep_delay,arr_delay|Departure and arrival delays, in minutes. Negative times represent early departures/arrivals.|
|flights|carrier|carrier|Two letter carrier abbreviation. See airlines() to get name|
|flights|flight|flight|Flight number|
|flights|tailnum|tailnum|Plane tail number|
|flights|origin|origin|Origin of flight or weather station|
|flights|dest|dest|Destination of flight. See airports() for additional metadata.|
|flights|air_time|air_time|Amount of time spent in the air, in minutes|
|flights|distance|distance|Distance between airports, in miles|
|flights|hour|hour|Hour part of time of scheduled departure or weather recording|
|flights|minute|minute|Minute part of time of scheduled departure|
|flights|time_hour|time_hour|Scheduled date and hour of the flight or of the weather recording as a POSIXct date|
|weather|origin|origin|Origin of flight or weather station|
|weather|year|year,month,day|Date of departure or date of weather recording|
|weather|month|year,month,day|Date of departure or date of weather recording|
|weather|day|year,month,day|Date of departure or date of weather recording|
|weather|hour|hour|Hour part of time of scheduled departure or weather recording|
|weather|temp|temp,dewp|Temperature and dewpoint in F|
|weather|dewp|temp,dewp|Temperature and dewpoint in F|
|weather|humid|humid|Relative humidity|
|weather|wind_dir|wind_dir,wind_speed,wind_gust|Wind direction (in degrees), speed and gust speed (in mph)|
|weather|wind_speed|wind_dir,wind_speed,wind_gust|Wind direction (in degrees), speed and gust speed (in mph)|
|weather|wind_gust|wind_dir,wind_speed,wind_gust|Wind direction (in degrees), speed and gust speed (in mph)|
|weather|precip|precip|Precipitation, in inches|
|weather|pressure|pressure|Sea level pressure in millibars|
|weather|visib|visib|Visibility in miles|
|weather|time_hour|time_hour|Scheduled date and hour of the flight or of the weather recording as a POSIXct date|
|planes|tailnum|tailnum|Plane tail number|
|planes|year|year(2)|Year manufactured,Renamed to manuf_year|
|planes|type|type|Type of plane|
|planes|manufacturer|manufacturer,model|Manufacturer and model|
|planes|model|manufacturer,model|Manufacturer and model|
|planes|engines|engines,seats|Number of engines and seats|
|planes|seats|engines,seats|Number of engines and seats|
|planes|speed|speed|Average cruising speed in mph|
|planes|engine|engine|Type of engine|


This table represents a table of static data linking airline codes to airline descriptions:

|carrier_code|carrier_description|
|---|---|
|9E|Endeavor Air Inc.|
|AA|American Airlines Inc.|
|AS|Alaska Airlines Inc.|
|B6|JetBlue Airways|
|DL|Delta Air Lines Inc.|
|EV|ExpressJet Airlines Inc.|
|F9|Frontier Airlines Inc.|
|FL|AirTran Airways Corporation|
|HA|Hawaiian Airlines Inc.|
|MQ|Envoy Air|
|OO|SkyWest Airlines Inc.|
|UA|United Air Lines Inc.|
|US|US Airways Inc.|
|VX|Virgin America|
|WN|Southwest Airlines Co.|
|YV|Mesa Airlines Inc.|

For categorical independent variables, the below table, cat_facts, shows associated departure delay. If desired, it could also be used for manual back-transformation

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
cat_facts %>% mutate(facts = round(facts,4))
```


## Ax.2 For further study

### On working with a binary delay rather than a time of delay

Here's the histogram for dep_delay again
```{r message=FALSE, warning=FALSE}
flights %>%
  ggplot(mapping = aes(dep_delay)) +
  geom_histogram(na.rm = T) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  labs(title = 'A large majority of flights clump around 0'
         ,subtitle = paste('But', sum(flights$dep_delay >= 600, na.rm = T), 'flights delayed more than 10 hours skew everything'))
```


Regardless of which category I grouped flights by, it was apparent that most flights in 2013 saw little to no delay. However, because there were a handful of outliers, it could skew the data when using mean, dramatically altering my results for a categorical variable. In turn, my predictions based on mean would be pretty far off most of the time, and only useful when averaging out a large number of flights that any given traveler might not make in a lifetime.

As an example, suppose a carrier was on time 99 times, but once, due to a fluke occurence of icy rain, was delayed by 15 hours.
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
tibble(dep_delay = c(rep(0.0,99), 15*60)) %>%
  ggplot(mapping = aes(dep_delay)) +
  geom_density(na.rm=T) +
  geom_vline(xintercept = 9, color = 'darkred', size = 2) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  xlim(-1, 30) +
  labs(caption = 'I set x-axis max limit to 30 min., so the bar at 900 isnt visible'
       ,title = 'The mean delay in red tells us nothing very useful')
```


### Picking a cutoff

One concern I had with this approach was ignoring much of the data. In particular, ignoring the magnitude of delay mattered because cutting off delayed vs. not delayed at 0 minutes was somewhat arbitrary.

There's a differnce between being delayed five minutes and being delayed an hour -- few would even notice the former while the latter would require a phone call or two to change plans.

As an example, suppose I had made the cut-off at five minutes making the two groups flight on time or nearly on time and flights delayed more than five minutes. It's already more cumbersome to say, but I'll graph it and I'll graph 30 and 60 minute cutoffs too.
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
flights %>% filter(!is.na(dep_delay) == T, dep_delay > 15) %>% ggplot(mapping = aes(dep_delay)) + geom_histogram(binwidth = 10) + theme_fivethirtyeight() +
  scale_color_fivethirtyeight() + ggtitle('A cutoff of 15 doesnt fix much')

flights %>% filter(!is.na(dep_delay) == T, dep_delay > 30) %>% ggplot(mapping = aes(dep_delay)) + geom_histogram(binwidth = 10) + theme_fivethirtyeight() +
  scale_color_fivethirtyeight() + ggtitle('A cutoff of 30 doesnt fix much')

flights %>% filter(!is.na(dep_delay) == T, dep_delay > 60) %>% ggplot(mapping = aes(dep_delay)) + geom_histogram(binwidth = 10) + theme_fivethirtyeight() +
  scale_color_fivethirtyeight() + ggtitle('A cutoff of 60 doesnt fix much')

```


For each of these, we always run into the same problem which is that the data remains clumped toward the left side and is highly skewed rightward. So picking 0 is as good as any.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
flt_skew <- flights %>%
  filter(!is.na(dep_delay)) %>%
  mutate(dep_delay = (dep_delay + abs(dep_delay))/2)

dep_delay_skew <- tibble(i = 0L, skew_rightward = 0.01, i_ratio_of_rightward = 0.01, mdn_rightward = 0L, mean_rightward = 1.12)

for(i in 0:120){
  dep_delay_skew[i+1,1] <- i
  dep_delay_skew[i+1,2] <- round(skewness(flt_skew %>% filter(dep_delay >= i) %>% select(dep_delay) %>% as_vector()), 2)
  dep_delay_skew[i+1,3] <- round(sum(flt_skew$dep_delay == i)/ sum(flt_skew$dep_delay >= i), 2)
  dep_delay_skew[i+1,4] <- median(flt_skew %>% filter(dep_delay >= i) %>% select(dep_delay) %>% as_vector())
  dep_delay_skew[i+1,5] <- round(mean(flt_skew %>% filter(dep_delay >= i) %>% select(dep_delay) %>% as_vector()))
}

dep_delay_skew
```


All bad choices. I generally wouldn't want a skew outside the range of -2 to 2. This never comes close.


```{r echo=FALSE, message=FALSE, warning=FALSE}
dep_delay_skew %>%
  ggplot() +
  geom_line(aes(i, skew_rightward, color = 'skew by cutoff')) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight(labels = 'skew by dep_delay cutoff'
                     ,name = '') +
  ggtitle('Skew never comes close to a useful value')
```




### Adding a second-level test for expected minutes delayed given that a flight is delayed

See the previous section. The heavy skew of the data means that number is likely to be off by a good amount.

